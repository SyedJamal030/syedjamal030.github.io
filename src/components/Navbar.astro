---
const { pathname } = Astro.url;
const activePath = pathname === "/" ? "/" : pathname.replace(/\/$/, "");

const isActive = (href: string) => {
  const normalizedHref = href === "/" ? "/" : href.replace(/\/$/, "");
  return activePath === normalizedHref;
};

const navData = [
  { name: "Home", href: "/" },
  { name: "Projects", href: "/projects" },
  { name: "About", href: "/about" },
];
---

<nav
  id="main-nav"
  class="fixed w-full lg:px-4 lg:py-6 md:px-3 md:py-4 px-2 py-2 top-0 z-50 transition-all duration-300 border-b border-transparent"
>
  <div class="lg:container mx-auto flex items-center md:justify-center justify-end">
    
    <div class="flex items-center gap-3">
      <button
        id="menu-toggle"
        class="group inline-flex md:hidden relative w-12 h-12 text-slate-800 dark:text-gray-300 text-center items-center justify-center rounded-full hover:shadow-[0_1px_0_theme(colors.slate.950/.04),0_4px_8px_theme(colors.slate.950/.12),inset_0_-2px_0_theme(colors.slate.950/.04)] transition [[aria-pressed=true]]:text-primary hover:!text-primary"
        aria-pressed="false"
      >
        <span class="sr-only">Menu</span>
        <svg
          class="w-6 h-6 fill-current pointer-events-none"
          viewBox="0 0 16 16"
          xmlns="http://www.w3.org/2000/svg"
        >
          <rect
            class="origin-center -translate-y-[5px] translate-x-[7px] transition-all duration-300 ease-[cubic-bezier(.5,.85,.25,1.1)] group-[[aria-pressed=true]]:translate-x-0 group-[[aria-pressed=true]]:translate-y-0 group-[[aria-pressed=true]]:rotate-[315deg]"
            y="7"
            width="9"
            height="2"
            rx="1"></rect>
          <rect
            class="origin-center transition-all duration-300 ease-[cubic-bezier(.5,.85,.25,1.8)] group-[[aria-pressed=true]]:rotate-45"
            y="7"
            width="16"
            height="2"
            rx="1"></rect>
          <rect
            class="origin-center translate-y-[5px] transition-all duration-300 ease-[cubic-bezier(.5,.85,.25,1.1)] group-[[aria-pressed=true]]:translate-y-0 group-[[aria-pressed=true]]:rotate-[135deg]"
            y="7"
            width="9"
            height="2"
            rx="1"></rect>
        </svg>
      </button>
      
      <div
        id="nav-menu"
        data-scrolled="false"
        class:list={[
          /* Mobile Styles (Always a Card) */
          "absolute top-full right-2 flex-col min-w-[200px] p-2 gap-2",
          "bg-card/95 backdrop-blur-xl border border-border shadow-xl rounded-2xl",

          /* Desktop Styles (Default: Pill) */
          "md:static md:flex md:flex-row md:items-center md:gap-1.5 md:p-1.5 md:rounded-full",
          "md:bg-card/80 md:border md:border-border md:shadow-lg md:backdrop-blur-md",

          /* Desktop Styles (On Scroll: Ghost) */
          "md:data-[scrolled=true]:bg-transparent md:data-[scrolled=true]:border-transparent md:data-[scrolled=true]:shadow-none md:data-[scrolled=true]:backdrop-blur-0",

          /* Transition & Toggle */
          "transition-all duration-500 [&[astro-menu-open]]:flex hidden",
        ]}
      >
        {
          navData.map((item) => (
            <a
              astro-menu-item
              href={item.href}
              class:list={[
                "relative px-6 py-2 text-sm font-semibold transition-all duration-300 rounded-full w-full md:w-auto text-center",
                isActive(item.href)
                  ? "text-primary-foreground"
                  : "text-muted-foreground hover:text-foreground hover:bg-primary/5",
              ]}
            >
              {isActive(item.href) && (
                <div
                  transition:name="nav-active-pill"
                  class="absolute inset-0 bg-primary rounded-full shadow-lg shadow-primary/20 -z-10"
                />
              )}
              <span class="relative z-10">{item.name}</span>
            </a>
          ))
        }
      </div>
    </div>
  </div>
</nav>

<style>
  #nav-menu {
    transition:
      transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
      background-color 0.3s,
      border-color 0.3s;
  }

  @media (max-width: 767px) {
    #nav-menu[astro-menu-open] {
      animation: menu-slide-in 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }
  }

  @keyframes menu-slide-in {
    from {
      opacity: 0;
      transform: translateY(-10px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
</style>

<script>
  const initNav = () => {
    const toggle = document.getElementById("menu-toggle");
    const menu = document.getElementById("nav-menu");

    if (!toggle || !menu) return;

    const openMenu = () => {
      toggle.setAttribute("aria-pressed", "true");
      menu.setAttribute("astro-menu-open", "");
    };

    const closeMenu = () => {
      toggle.setAttribute("aria-pressed", "false");
      menu.removeAttribute("astro-menu-open");
    };

    toggle.addEventListener("click", (e) => {
      e.stopPropagation();
      menu.hasAttribute("astro-menu-open") ? closeMenu() : openMenu();
    });

    document.addEventListener("click", (e) => {
      if (
        !toggle.contains(e.target as Node) &&
        !menu.contains(e.target as Node)
      ) {
        closeMenu();
      }
    });
  };

  initNav();
  document.addEventListener("astro:after-swap", initNav);
</script>
